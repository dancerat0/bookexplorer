<!doctype html>
<html lang="pt-br">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Book Explorer</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
</head>

<body onload="inicio()">
    <main class="container">
        <h1>Book Explorer</h1>
        <div class="row mb-4">
            <div class="col-lg-9">
                <input type="text" id="inputPesquisa" class="form-control" placeholder="Digite o nome do livro ou autor">
            </div>
            <div class="col-lg-3">
                <button class="btn btn-primary w-100" onclick="pesquisarLivro()">Pesquisar</button>
            </div>
        </div>
        <div class="row">
            <nav class="col-lg-3">
                <ul class="list-group" id="ulCategorias"></ul>
            </nav>
            <section class="col-lg-9">
                <div class="row" id="divCards"></div>
                <div class="row">
                    <div class="col-lg-12 text-center">
                        <button class="btn btn-secondary" id="loadMoreBtn" style="display:none;" onclick="loadMoreBooks()">Carregar mais</button>
                    </div>
                </div>
            </section>
        </div>

        <div class="row mt-4">
            <div class="col-lg-12 text-center">
                <button class="btn btn-info" data-bs-toggle="modal" data-bs-target="#logModal">Ver Logs</button>
            </div>
        </div>
    </main>

    <!-- Modal para exibir logs -->
    <div class="modal fade" id="logModal" tabindex="-1" aria-labelledby="logModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="logModalLabel">Lista de Logs</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" id="logContainer">
                    <!-- Logs serão carregados aqui -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
                </div>
            </div>
        </div>
    </div>

    <footer class="bg-light text-center text-lg-start mt-5">
        <div class="container p-4">
            <p class="text-muted">&copy; João Roberto S. Simonini - Fundamentos ao Desenvolvimento Web</p>
        </div>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>

    <script>
        let livros = [];
        let livrosExibidos = 0;
        const livrosPorPagina = 10;

        function inicio() {
            carregarCategorias();
        }

        function carregarCategorias() {
            const categorias = ['Ficção Científica', 'Fantasia', 'Romance', 'História', 'Terror'];
            let li = '';
            categorias.forEach(categoria => {
                li += `<li class="list-group-item">
                        <a href="#" onclick="carregarLivros('${categoria}')">${categoria}</a>
                    </li>`;
            });

            const ul = document.getElementById('ulCategorias');
            ul.innerHTML = li;
        }

        async function carregarLivros(genero) {
            const url = `https://openlibrary.org/subjects/${genero.toLowerCase().replace(' ', '_')}.json`;
            const res = await fetch(url).then(resposta => resposta.json());
            livros = res.works;
            livrosExibidos = 0;
            await inserirLog('carregarLivros', `Carregou livros de ${genero}`);
            exibirLivros();
        }

        async function pesquisarLivro() {
            const pesquisa = document.getElementById('inputPesquisa').value.trim();
            if (pesquisa === '') {
                alert('Por favor, insira o nome de um livro ou autor.');
                return;
            }

            const url = `https://openlibrary.org/search.json?q=${encodeURIComponent(pesquisa)}`;
            const res = await fetch(url).then(resposta => resposta.json());

            if (res.docs.length === 0) {
                alert('Nenhum resultado encontrado.');
                return;
            }

            livros = res.docs;
            livrosExibidos = 0;
            await inserirLog('pesquisarLivro', `Pesquisou: ${pesquisa}`);
            exibirLivros();
        }

        function exibirLivros() {
            let card = '';
            const div = document.getElementById('divCards');
            const livrosParaExibir = livros.slice(livrosExibidos, livrosExibidos + livrosPorPagina);

            livrosParaExibir.forEach(livro => {
                const coverId = livro.cover_i ? livro.cover_i : 'no_cover';
                const coverUrl = coverId !== 'no_cover'
                    ? `https://covers.openlibrary.org/b/id/${coverId}-L.jpg`
                    : 'https://via.placeholder.com/150';

                const bookKey = livro.key ? livro.key : `/works/${livro.edition_key ? livro.edition_key[0] : ''}`;

                card += `<div class="col-lg-4 mb-3">
                        <div class="card">
                            <img src="${coverUrl}" class="card-img-top" alt="${livro.title || 'Capa do livro'}">
                            <div class="card-body">
                                <h5 class="card-title">${livro.title || 'Título desconhecido'}</h5>
                                <p class="card-text">Autor: ${livro.author_name && livro.author_name.length > 0 ? livro.author_name[0] : 'Desconhecido'}</p>
                            </div>
                            <div class="card-body">
                                <a href="https://openlibrary.org${bookKey}" class="card-link" target="_blank">Mais detalhes</a>
                            </div>
                        </div>
                    </div>`;
            });

            if (livrosExibidos + livrosPorPagina < livros.length) {
                document.getElementById('loadMoreBtn').style.display = 'block';
            } else {
                document.getElementById('loadMoreBtn').style.display = 'none';
            }

            div.innerHTML = livrosExibidos === 0 ? card : div.innerHTML + card;
            livrosExibidos += livrosPorPagina;
        }

        function loadMoreBooks() {
            exibirLivros();
        }

        async function inserirLog(metodo, resultado) {
            await fetch(`https://www.piway.com.br/unoesc/api/inserir/log/430754/OpenLibraryAPI/${metodo}/${resultado}`)
                .then(resposta => { return resposta.json() });
        }

        async function ExcluirLog(id) {
            await fetch(`https://www.piway.com.br/unoesc/api/excluir/log/${id}/aluno/430754`)
                .then(resposta => { return resposta.json() });
        }

        async function exibirLogs() {
            try {
                const response = await fetch('https://www.piway.com.br/unoesc/api/logs/430754');
                if (!response.ok) {
                    console.error('Erro ao buscar logs:', response.statusText);
                    return;
                }

                const logs = await response.json();
                const logContainer = document.getElementById('logContainer');
                logContainer.innerHTML = '';

                if (logs.length === 0) {
                    logContainer.innerHTML = '<p>Nenhum log encontrado.</p>';
                } else {
                    logs.forEach(log => {
                        const livro = log.livro || 'Desconhecido';
                        const autor = log.autor || 'Desconhecido';
                        const genero = log.genero || 'Desconhecido';
                        const ano = log.ano || 'Desconhecido';
                        const logId = log.id || '0';

                        const logEntry = `
                            <div class="log-entry">
                                <p><strong>Livro:</strong> ${livro}</p>
                                <p><strong>Autor:</strong> ${autor}</p>
                                <p><strong>Gênero:</strong> ${genero}</p>
                                <p><strong>Ano:</strong> ${ano}</p>
                                <button class="btn btn-danger" onclick="ExcluirLog(${logId})">Excluir</button>
                            </div>
                            <hr>
                        `;
                        logContainer.innerHTML += logEntry;
                    });
                }
            } catch (error) {
                console.error('Erro ao carregar logs:', error);
            }
        }

        document.getElementById('logModal').addEventListener('shown.bs.modal', exibirLogs);
    </script>
</body>

</html>
